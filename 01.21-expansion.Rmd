## Overview of Store Selection and Expansion {#store-selection-1 -}

How the 17 "treatment" stores and 15 "control" stores were selected in 2016 is important. First and foremost, selection was *not* random. Stores were either selected by the company (13 of 17) or self-selected into Double Up (4 of 17). Second, the 15 control stores were selected *after* the selection of the 17 treatment stores. Data from all remaining stores was requested but the request was denied; only 15 stores had been approved by the company's management. Finally, and most importantly, the selection criteria for the 17 treatment stores is *observable*. The implications of this will be covered in more detail in the [Methods](#methods) section.

### Selection and Expansion of Double Up Stores {-}

The first 2 stores were piloted with Double Up in 2014. Both were in geographically distinct areas (these will be referred to as "`Node 0`" and "`Node 1`"). There was a small expansion adding 3 more stores in 2015. The 3 stores were selected because they were geographically close to the 2 original pilot stores (2 close to `Node 0`, 1 close to `Node 1`). The 5 stores are referred to as the "core". The location of these 5 stores, separated in two clusters, established the geographic constraints that were then used to determine most of the additional stores in 2016.

Double Up was expanded to 12 more stores in 2016, totaling 17. Of those 12, 6 were selected due to their proximity to the 5 core stores, their SNAP EBT^[Electronic Benefit Transfer.] sales figures, and similarity in surrounding demographics (high population density, more African-American). In other words, 9 of the 17 stores---excluding the initial 2 pilot storesâ€”--were selected on a set of *observable* characteristics. The remaining 6 stores were not.

Of the remaining 6 stores, 4 asked if they could be included in the program. These stores *self-selected* into Double Up, making these stores fundamentally distinct. They were considered, and then included, only because they fell within the "Top 50". The final 2 stores were selected by the company for "strategic business decision". The best interpretation of this is that the company thought that Double Up would provide a competitive edge to the 2 included stores given some internal calculus. How the company came to this decision is *unknown* and therefore *unobserved*.

Table \@ref(tab:store-class) helps understand the year by year expansion of Double Up. Stores are classified as either `assigned`, `self-selected`, or `unobserved`. To be `assigned` means a stores participation in Double Up was determined (assigned) by the company; `self-selected` means the store asked the company to participate; `unobserved` means that the company selected the store to participate in Double Up but for unknown and unobserved reasons. Numbers were assigned to each store for easy reference but otherwise have no meaningful interpretation.


```{r store-class, warning=FALSE, message=FALSE, echo=FALSE, eval=TRUE}

tbl_df <- dufb_sn_df %>%
  dplyr::arrange(-dufb_2014, -dufb_2015, -dufb_2016, unknown) %>%
  dplyr::mutate(store_id = 1:length(store)) %>%
  dplyr::select(store, store_id, c(4:10)) %>%
  dplyr::mutate(type = if_else(self_selected == 1,
    'self-selected',
    'assigned')) %>%
  dplyr::mutate(type = if_else(unknown == 1, 'unobserved', type)) %>%
  dplyr::mutate(type = if_else(dufb_2014 == 1, 'pilot', type)) %>%
  dplyr::select(store_id, type, dplyr::contains('dufb'))

tbl <- tbl_df %>%
  dplyr::mutate(`2014` = if_else(dufb_2014 == 1, type, '')) %>%
  dplyr::mutate(`2015` = if_else(dufb_2015 == 1, type, '')) %>%
  dplyr::mutate(`2016` = if_else(dufb_2016 == 1, type, '')) %>%
  dplyr::select(store_id, `2014`:`2016`) %>%
  dplyr::rename(Store = store_id) %>%
  knitr::kable(., caption = 'Year by Year Store Selection. Stores 1 and 2 represent the initial 2014 pilot stores.', booktabs = TRUE)
tbl
```

### Expansion on Observables {-}

An example expansion on *observables* (using fake data) can be seen in Figure \@ref(fig:dufb-expansion). In the top frame, one can see two blue dots. These blue dots simulate the first two pilot stores in 2014. The left blue dot is `Node 0` and the right blue dot is `Node 1`. The gray zones represent areas of higher population density. Dark gray is considered *urban*, defined as having a population density of 1500 persons or more per square mile. The light gray are small towns and cities, more densely populated than very rural areas, but could not be considered *urban*. The expansion in 2015 (middle frame) proceeds to the stores closest to the original pilot stores. The expansion continues to 6 more stores in 2016 (bottom frame) away from the nodes but also along areas of higher population density.

Not conveyed in Figure \@ref(fig:dufb-expansion) is that the 2015 and 2016 expansions also move through stores that happen to be "highly ranked"---that is, have relatively higher SNAP EBT sales.^[All stores within the chain were ranked by SNAP EBT sales as a percentage of total sales.] Also not conveyed is the fact that there is a strong correlation between geography, population density, racial composition, and SNAP EBT sales. The 2015 expansion to the most nearby stores also meant that it was an expansion to stores with high SNAP EBT sales in densely populated, African-American neighborhoods. The 2016 Double Up expansion was more explicit given that set of feasible stores substantially increases as one moves away from each node. Double Up stores were thus specifically selected not just by geographic proximity, but also by SNAP EBT sales ranking and demographic compositions similar to the initial 2014 stores.

```{r fig-dufb-expansion-setup, warning=FALSE, message=FALSE, echo=FALSE, eval=TRUE}

if(getOutputFormat() == "latex") pdf_yes = TRUE else pdf_yes = FALSE

# set up text
raw <- function(x) knitr::asis_output(x)

a <- list()

a[[1]] <- ("```{r dufb-expansion, fig.cap = 'Example expansion over time from 2014 to 2016 (top to bottom) using fake data. Blue dots denote stores with Double Up, pink dots denote without. Gray sectors denote higher population density. The initial nodes can be seen in the top (2014) frame.', fig.align='center', echo=FALSE}")
a[[2]] <- ("knitr::include_graphics('figures/expansion-v.pdf')")
if(!pdf_yes) a[[2]] <- gsub('pdf', 'png', a[[2]])
a[[3]] <- ("```")

out <- paste(a, collapse = '\n')
```

```{r fig-dufb-expansion-output, warning=FALSE, message=FALSE, eval=TRUE, echo=FALSE}
# MUST paste the output. cannot just knit!
raw(paste(knitr::knit(text = paste(out), quiet = TRUE)))
```
